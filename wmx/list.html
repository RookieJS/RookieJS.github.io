<!doctype html>
<html lang="en">
	<meta charset="UTF-8">
	<title>demo</title>
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, minimal-ui" >
	<meta name="apple-mobile-web-app-capable" content="yes" >
	<meta name="apple-mobile-web-app-status-bar-style" content="black" >
	<meta name="format-detection"content="telephone=no, email=no" >
	<meta name="renderer" content="webkit">
	<meta name="description" content="">
	<meta name="keywords" content=""> 
	<meta content="fullscreen=yes,preventMove=no" name="ML-Config">
	<meta content="yes" name="apple-touch-fullscreen">
	<link type="text/css" rel="stylesheet" href="css/reset.css">
	<link type="text/css" rel="stylesheet" href="css/page.css">
	<link type="text/css" rel="stylesheet" href="css/list.css">
	<link type="text/css" rel="stylesheet" href="css/swiper.min.css">
	<style type="text/css">
		.swiper-container {
	        width: 100%;
	        height: 100%;
	    }
	    .swiper-slide {
	        height: auto;
	        -webkit-box-sizing: border-box;
	        box-sizing: border-box;
	    }
	</style>
	<body>
		<header>
			<ul class="tab">
				<li class="now"><a href="###">最新上传</a></li>
				<li><a href="###">集赞榜单</a></li>
			</ul>
		</header>
		<section class="noflex">
			<div class="user-list">
				<div class="">
					<p>YOUR<br>PHOTOS</p>
					<p>您上传的<br>照片</p>
				</div>
				<ul class="list">
					<li>
						<a href="http://www.xici.net">
							<div class="pic">
								<img src="images/demo.jpg" alt="">
								<div class="tip">888赞</div>
							</div>
						</a>
					</li>
					<li>
						<a href="http://www.xici.net">
							<div class="pic">
								<img src="images/demo.jpg" alt="">
								<div class="tip">888赞</div>
							</div>
						</a>
					</li>
					<li>
						<a href="http://www.xici.net">
							<div class="pic">
								<img src="images/demo.jpg" alt="">
								<div class="tip">888赞</div>
							</div>
						</a>
					</li>
				</ul>
			</div>
		</section>
		<section class="o-list">
		    <div class="swiper-container">
		        <div class="swiper-wrapper">
		            <div class="swiper-slide">
		                <ul class="l-r"></ul>
						<ul class="l-l"></ul>
		            </div>
		        </div>
		          <!-- Add Scroll Bar -->
   	 			<div class="swiper-scrollbar"></div>
   	 			<div class="loading-min"><img src="images/p.gif"></div>
		    </div>
		</section>
		<footer>
			<nav>
				<ul>
					<li class="home l-a"></li>
					<li class="rule l-a"></li>
					<li class="signup l-a"></li>
					<li class="ranking l-a now"></li>
				</ul>
			</nav>
		</footer>
		<script type="text/javascript" src="js/jquery-2.1.4.min.js"></script>
		<script type="text/javascript" src="js/swiper.js"></script>
		<script type="text/javascript" src="js/oboe-browser.min.js"></script>
		<script type="text/javascript" src="js/juicer-min.js"></script>
		<script type="text/javascript" src="js/common.js"></script>
		<script type="text/template" id="pic-show">
			<li>
				<div class="pic">
					<div class="tip-top"><span>${slogan}</span></div>
					<img src="${imgSrc}" alt="" data-w="${width}" data-h="${height}">
					<div class="tip-bottom"><em>${count}</em>赞<i data-id="${dataId}"></i></div>
				</div>
			</li>
		</script>
		<script type="text/javascript">
			var template = null;
			var swiper = null;
			var leftPanel = null;
			var rightPanel = null;
			var pageObject = {
				currentPage:1,
				sizePage:6,
				isEnd:false
			}


			$(function(){
				template = juicer($("#pic-show").html())
				leftPanel = $(".o-list .l-l");
				rightPanel = $(".o-list .l-r");

				$(".swiper-container").height($(".o-list").height());
				

				swiper = new Swiper('.swiper-container', {
			        scrollbar: '.swiper-scrollbar',
			        direction: 'vertical',
			        slidesPerView: 'auto',
			        mousewheelControl: true,
			        freeMode: true,
			        onTouchEnd: function(swiper){
			        	//松手刷新
					    if(swiper.translate>70)
					    {
					    	pageObject.currentPage = 1;
					    	pageObject.isEnd = false;
					    	leftPanel.empty();
					    	leftPanel.attr("t-height","0");

							rightPanel.empty();
							rightPanel.attr("t-height","0");
					    	//up
					    	ajaxData();
					    }
					    else if(swiper.height-swiper.slides.height()+swiper.translate<-50)
					    {
					    	if(pageObject.isEnd) return ;
					    	pageObject.currentPage++;
					    	//down
					    	ajaxData();
					    }
				    }
			    });


				$(".o-list").on("click","i",function(event){
					
					event.preventDefault();
					event.stopPropagation()
					return false;
					
				})

				$(".o-list").on("click","li",function(event){
					if(event.target.tagName == "i")
					{
						return ;
					}
					var src = $("img",$(this)).attr("src")
					$("body").append("<div class='fiex-pic' style='background-image:url("+src+")'></div>");
					$(".fiex-pic").one("click",function(){
						this.remove();
					})
				})

				leftPanel.attr("t-height","0");
				rightPanel.attr("t-height","0");
				ajaxData();
			})

		function ajaxData(){
			oboe('data/temp'+pageObject.currentPage+'.json').done(function(data) {
				if(data.array.length < pageObject.sizePage)  pageObject.isEnd = true;
				/*图片加载*/
				loadImg(data);
			}).fail(function(data) {
				alert("get data error!");
			});
		}

		function loadImg(data){
			var deferreds = [];
			$.each(data.array,function(n,m){
				var dtd = $.Deferred();
				var img = new Image();
				img.src = m.imgSrc;
				img.onload = function(){
					data.array[n].width = this.width;
					data.array[n].height = this.height;
					dtd.resolve();
				}
				if(img.complete)
				{
					data.array[n].width = img.width;
					data.array[n].height = img.height;
					dtd.resolve();
				}
				deferreds.push(dtd);
			})

			$.when.apply(null,deferreds).done(function(){
				var eles = [];
				$.each(data.array,function(n,m){
					eles.push(template.render(m));
				})
				/*计算瀑布流*/
				caWaterfall(eles,data.array);
			}).fail(function(){ 
				alert("load img error!");
			});
		}

		var base = 100;
		var addPanel = null;
		function caWaterfall (list,array){
			$.each(list,function(n,m){
				addPanel = parseFloat(leftPanel.attr("t-height")) <=  parseFloat(rightPanel.attr("t-height")) ? leftPanel : rightPanel;
				addPanel.attr("t-height",parseFloat(addPanel.attr("t-height")) + base/array[n].width*array[n].height);
				addPanel.append(m);
			})
			swiper.updateProgress();	
			swiper.onResize();
		}

		</script>
	</body>
</html>
